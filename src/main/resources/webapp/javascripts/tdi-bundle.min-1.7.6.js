/*!
 * Twinstone TDI (http://wiki.twinstone.org/display/TDI)
 * Version: 1.7.6
 *
 * Copyright 2013 Etnetera a.s. http://www.etnetera.cz
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
if(typeof jQuery=="undefined"){throw ("Missing dependency: jQuery!");}var TDI=function($){return{};}(jQuery);TDI.Ajax=function($){var _delegateSelectors={linkClick:"a.ajaxlink, a.tdi, a.infuse",formSubmit:"form.ajaxform, form.tdi, form.infuse",formButtonActivate:"form.ajaxform [type=submit], form.tdi [type=submit], form.infuse [type=submit]",fieldChange:"select.ajaxselect, select.tdi, select.infuse, input[type=checkbox].tdi, input[type=checkbox].infuse, input[type=radio].tdi, input[type=radio].infuse",fieldSubmit:"input[type=text].tdi, input[type=text].infuse"};function _bindUI(){$(document).delegate(_delegateSelectors.formSubmit,"submit",_onBeforeFormSubmit).delegate(_delegateSelectors.linkClick,"click",_onBeforeLinkClick).delegate(_delegateSelectors.formButtonActivate,"click",_onFormButtonActivate).delegate(_delegateSelectors.fieldChange,"change",_onFieldChange).delegate(_delegateSelectors.fieldSubmit,"keydown",_onFieldSubmit);$(window).unload(_unbindUI);$.event.special["tdi:ajax:beforeLinkClick"]={_default:_onLinkClick};$.event.special["tdi:ajax:beforeFormSubmit"]={_default:_onFormSubmit};}function _unbindUI(evt){$(document).undelegate(_delegateSelectors.linkClick,"click",_onLinkClick).undelegate(_delegateSelectors.formSubmit,"submit",_onBeforeFormSubmit).undelegate(_delegateSelectors.formButtonActivate,"click",_onFormButtonActivate).undelegate(_delegateSelectors.fieldChange,"change",_onFieldChange).undelegate(_delegateSelectors.fieldSubmit,"keydown",_onFieldSubmit);}function _onBeforeLinkClick(evt){evt.preventDefault();$(this).trigger("tdi:ajax:beforeLinkClick",{link:$(this)});return false;}function _onLinkClick(evt){TDI.Ajax.send(evt.target);}function _onBeforeFormSubmit(evt){evt.preventDefault();$(this).trigger("tdi:ajax:beforeFormSubmit",{form:$(this)});return false;}function _onFormSubmit(evt){TDI.Ajax.send(evt.target);}function _onFormButtonActivate(evt){var $button=$(this),$form=$(this.form);$form.data("_submitButton",$button);if($button.attr("name")){$form.find("input.submit-action").remove();$("<input>").attr("type","hidden").attr("name",$button.attr("name")).attr("value",$button.attr("value")).addClass("submit-action").appendTo($form);}}function _onFieldChange(evt){TDI.Ajax.send($(this).data("ajax-url")?this:this.form);}function _onFieldSubmit(evt){if(evt.keyCode===13&&$(this).data("ajax-url")){evt.preventDefault();TDI.Ajax.send(this);}}_bindUI();return{send:function(elm,callbacks){callbacks=callbacks||{};var $elm=$(elm),name=$elm.attr("name"),value=$elm.val(),confirm=$elm.data("confirm"),related=$elm.closest($elm.data("related-ancestor")||"").add($($elm.data("related-element")||"")).add($($elm.attr("rel")||"")).add($($elm.data("_submitButton")||"")),triggerGroup=$($elm.data("trigger-group")||""),url=$elm.data("ajax-url")||$elm.attr("href")||$elm.attr("action"),xhrFields=$elm.data("ajax-xhr-fields")||{},data={};if((url===""||url===undefined)&&value){url=value;}if(name&&value){if($elm.is("input[type=checkbox]")&&$elm.prop("checked")===false){data[name]=0;}else{data[name]=value;}}if($elm.is("[disabled], .disabled")){return false;}if(confirm&&!window.confirm(confirm)){return false;}var _options={beforeStart:function(){var res=callbacks.beforeStart&&callbacks.beforeStart.apply(this,arguments);if(typeof res==="undefined"||res===true){$elm.add(related).addClass("loading");triggerGroup.each(function(){var $trigger=$(this);if(!$trigger.hasClass("disabled")&&!$trigger.prop("disabled")){$trigger.addClass("disabled").prop("disabled",true);$trigger.data("_disabled",true);}});related.get(0)&&related.addClass("loading-target");callbacks.start&&callbacks.start.apply(this,arguments);return true;}return false;},beforeEnd:function(){var res=callbacks.beforeEnd&&callbacks.beforeEnd.apply(this,arguments);if(typeof res==="undefined"||res===true){$elm.add(related).removeClass("loading");triggerGroup.each(function(i,$trigger){var $trigger=$(this);if($trigger.data("_disabled")===true){$trigger.removeClass("disabled").prop("disabled",false);$trigger.data("_disabled",false);}});related.get(0)&&related.removeClass("loading-target");callbacks.end&&callbacks.end.apply(this,arguments);}},data:data,trigger:$elm,xhrFields:xhrFields};if($elm.is("form")){_options.end=function(){$elm.data("_submitButton",null);$elm.find("input.submit-action").remove();};if($elm.find("input[type=file]").length>0){TDI.Ajax.Request.sendForm($elm[0],_options);}else{_options.data=$elm.serialize();_options.method=$elm.attr("method");TDI.Ajax.Request.send(url,_options);}}else{TDI.Ajax.Request.send(url,_options);}}};}(jQuery);TDI.Ajax.Request=function($){return{send:function(url,options){options=options||{};options.url=TDI.Ajax.Request.ajaxifyUrl(url);$.ajax({url:options.url,xhrFields:options.xhrFields||{},type:options.method||"GET",async:!options.sync,data:options.data||"",dataType:"xml",beforeSend:function(xhr,settings){var res=options.beforeStart&&options.beforeStart(xhr,settings,options);if(typeof res==="undefined"||res===true){$(document).trigger("tdi:ajax:_start",{xhr:xhr,settings:settings,options:options});options.start&&options.start(xhr,settings,options);return true;}return false;},success:function(data,textStatus,xhr){$(document).trigger("tdi:ajax:_success",{data:data,textStatus:textStatus,xhr:xhr,options:options});options.success&&options.success(data,textStatus,xhr,options);},error:function(xhr,textStatus,error){$(document).trigger("tdi:ajax:_error",{xhr:xhr,textStatus:textStatus,error:error,options:options});options.error&&options.error(xhr,textStatus,error,options);},complete:function(xhr,textStatus){var res=options.beforeEnd&&options.beforeEnd(xhr,textStatus,options);if(typeof res==="undefined"||res===true){$(document).trigger("tdi:ajax:_end",{xhr:xhr,textStatus:textStatus,options:options});options.end&&options.end(xhr,textStatus,options);}}});},sendForm:function(form,options){options=options||{};var $form=$(form),$submitButton=$form.data("_submitButton"),url=$form.data("ajax-url")||$form.attr("action");options.url=TDI.Ajax.Request.ajaxifyUrl(url);var res=options.beforeStart&&options.beforeStart($form,options);if(res===false){return false;}$(document).trigger("tdi:ajax:_start",{xhr:$form,settings:null,options:options});options.start&&options.start($form,options);if($submitButton){$submitButton.addClass("loading");}var iframeName="form_iframe_"+(new Date()).getTime(),iframe;if(document.documentMode&&document.documentMode<=8){iframe=document.createElement('<iframe name="'+iframeName+'">');}else{iframe=document.createElement("iframe");iframe.name=iframeName;}iframe.style.display="none";document.body.appendChild(iframe);$(iframe).load(function(){var xml=this.contentWindow.document.XMLDocument||this.contentWindow.document,xhr={responseXML:xml,responseText:(xml.body)?xml.getElementsByTagName("html")[0].innerHTML:null};var res=options.beforeEnd&&options.beforeEnd($form,options,xml);if(res===false){return false;}if($submitButton){$submitButton.removeClass("loading");}$(document).trigger("tdi:ajax:_success",{data:xml,textStatus:"",xhr:xhr,options:options});$(document).trigger("tdi:ajax:_end",{xhr:$form,textStatus:null,options:options});$form.trigger("tdi:ajax:_formSubmit",{form:$form,options:options,xhr:xhr,data:xml});options.end&&options.end($form,options,xml);setTimeout(function(){$(iframe).unbind().remove();$form.removeAttr("target");},100);});$form.attr("action",options.url);$form.attr("method","post");$form.attr("target",iframeName);$form.attr("enctype","multipart/form-data");$form[0].submit();},ajaxifyUrl:function(url){var p="_infuse=1&_ts="+(new Date()).getTime();if(url.indexOf("?#")>0){return url.replace(/\?#/,"?"+p+"#");}else{if(url.indexOf("&#")>0){return url.replace(/&#/,"&"+p+"#");}else{if(url.indexOf("?")>0){return url.replace(/\?/,"?"+p+"&");}else{if(url.indexOf("#")>=0){return url.replace(/#/,"?"+p+"#");}else{return url+"?"+p;}}}}}};}(jQuery);TDI.Ajax.Response=function($){$(document).bind("tdi:ajax:_start",function(evt,data){_start(data.xhr,data.settings,data.options);});$(document).bind("tdi:ajax:_success",function(evt,data){_success(data.data,data.textStatus,data.xhr,data.options);});$(document).bind("tdi:ajax:_error",function(evt,data){_error(data.xhr,data.textStatus,data.error,data.options);});$(document).bind("tdi:ajax:_end",function(evt,data){_end(data.xhr,data.textStatus,data.options);});var _infusionInstructions={update:_onBeforeUpdate,insert:_onBeforeInsert,script:_onBeforeScript,style:_onBeforeStyle,reload:_onBeforeReload,redirect:_onBeforeRedirect,popup:_onBeforePopup};var _scriptTags=[];var _responses={updates:[],inserts:[],scripts:[],styles:[],popups:[],unknowns:[]};function _start(xhr,settings,options){$(document).trigger("tdi:ajax:start",[{xhr:xhr,options:options,settings:settings}]);}function _success(xml,textStatus,xhr,options){if(!xml){_error(xhr,textStatus,null,options);return false;}var $xml=$(xml),status=$xml.find("status");if(status.text().toLowerCase()!="ok"){_error(xhr,textStatus,status.text(),options);}$xml.find("response > *:not(status)").each(function(){var instruction=this.tagName.toLowerCase();switch(instruction){case"Script":_scriptTags.push(this);break;default:if(_infusionInstructions[instruction]){_infusionInstructions[instruction](this,options);}else{_onBeforeUnknown(this,options);}break;}});_onBeforeScript(_scriptTags.shift(),options);$(document).trigger("tdi:ajax:updatesDone",[{updates:_responses.updates,options:options}]);$(document).trigger("tdi:ajax:insertsDone",[{inserts:_responses.inserts,options:options}]);$(document).trigger("tdi:ajax:scriptsDone",[{scripts:_responses.scripts,options:options}]);$(document).trigger("tdi:ajax:stylesDone",[{styles:_responses.styles,options:options}]);$(document).trigger("tdi:ajax:popupsDone",[{popups:_responses.popups,options:options}]);$(document).trigger("tdi:ajax:unknownsDone",[{unknowns:_responses.unknowns,options:options}]);$(document).trigger("tdi:ajax:done",[{responses:_responses,options:options}]);}function _error(xhr,textStatus,error,options){$(document).trigger("tdi:ajax:error",[{status:xhr?xhr.status:"N/A",message:error||"Invalid Ajax response. The response must be a valid XML.",xhr:xhr,textStatus:textStatus,options:options}]);}function _end(xhr,textStatus,options){$(document).trigger("tdi:ajax:end",[{options:options}]);}function _onBeforeUpdate(tag,options){if(!tag){return false;}var $tag=$(tag),target_id=$tag.attr("target"),target=$("#"+$tag.attr("target")),content=$.trim($tag.text()),replace=$tag.attr("replace"),append=$tag.attr("append"),prepend=$tag.attr("prepend"),class_add=$tag.attr("class-add")||"",class_remove=$tag.attr("class-remove")||"",event_data={target_id:target_id,target:target,content:content,content_empty:(content.replace(/\&nbsp;/g,"").length===0),replace:replace,append:append,prepend:prepend,class_add:class_add,class_remove:class_remove,options:options};if(target.get(0)){target.trigger("tdi:ajax:beforeUpdate",event_data);_responses.updates.push(event_data);}}function _onBeforeInsert(tag,options){if(!tag){return false;}var $tag=$(tag),target_id=$tag.attr("target"),target=$("#"+target_id),content=$.trim($tag.text()),position=$tag.attr("position")||"after",inserted_node,event_data={target_id:target_id,target:target,content:content,position:position,inserted_node:inserted_node,options:options};if(target.get(0)){target.trigger("tdi:ajax:beforeInsert",event_data);_responses.inserts.push(event_data);}}function _onBeforeScript(tag,options){if(!tag){return false;}var $tag=$(tag),contents=$.trim($tag.text()),src=$tag.attr("src"),id=$tag.attr("id"),event_data={script_src:src,script_data:contents,script_id:id,options:options};$(document).trigger("tdi:ajax:beforeScript",event_data);_responses.scripts.push(event_data);}function _onBeforeStyle(tag,options){if(!tag){return false;}var $tag=$(tag),src=$tag.attr("src"),id=$tag.attr("id"),event_data={style_src:src,style_id:id,options:options};$(document).trigger("tdi:ajax:beforeStyle",event_data);_responses.styles.push(event_data);}function _onBeforeReload(tag,options){$(document).trigger("tdi:ajax:beforeReload",{options:options});}function _onBeforeRedirect(tag,options){if(!tag){return false;}var $tag=$(tag),href=$tag.attr("href");if(href){$(document).trigger("tdi:ajax:beforeRedirect",{href:href,options:options});}}function _onBeforePopup(tag,options){if(!tag){return false;}var $tag=$(tag),mode=$tag.attr("mode")||"popup",href=$tag.attr("href"),width=$tag.attr("width")||600,height=$tag.attr("height")||500,event_data={href:href,mode:mode,width:parseInt(width),height:parseInt(height),options:options};if(href){$(document).trigger("tdi:ajax:beforePopup",event_data);_responses.popups.push(event_data);}}function _onBeforeUnknown(tag,options){if(!tag){return false;}var $tag=$(tag),name=tag.tagName.toLowerCase(),beforeName=name.substr(0,1).toUpperCase()+name.substr(1),attributes=tag.attributes,event_data={_name:name,contents:$.trim($tag.text())};for(var i=0,l=attributes.length;i<l;i++){event_data[attributes[i].name]=attributes[i].value;}$.event.special["tdi:ajax:before"+beforeName]={_default:customDefault};$(document).trigger("tdi:ajax:before"+beforeName,event_data);_responses.unknowns.push(event_data);}function _onUpdateDefault(evt,data){data.target.removeClass(data.class_remove).addClass(data.class_add);if(data.replace==="true"){data.target.find("*").andSelf().unbind();data.target.replaceWith(data.content);}else{if(data.append==="true"){data.target.append(data.content);}else{if(data.prepend==="true"){data.target.prepend(data.content);}else{data.target.find("*").unbind();data.target.html(data.content);}}}data.target.trigger("tdi:ajax:update",data);}function _onInsertDefault(evt,data){data.inserted_node=$(data.content)[(data.position==="before")?"insertBefore":"insertAfter"](data.target);data.target.trigger("tdi:ajax:insert",data);}function _onScriptDefault(evt,data){var scripts=_scriptTags,download=true,onComplete=function(node){var s;if(data.script_data){s=document.createElement("script");s.type="text/javascript";s.text=data.script_data;if(data.script_id){s.id=data.script_id+"_inline";}document.getElementsByTagName("head")[0].appendChild(s);}data.script_node=node;data.script_node_inline=s;$(document).trigger("tdi:ajax:script",data);_onBeforeScript(scripts.shift());};if(data.script_src){if(data.script_id&&$("#"+data.script_id).length>0){download=false;}if(download){TDI.Tools.getScript(data.script_src,{id:data.script_id,complete:onComplete});}}else{onComplete();}}function _onStyleDefault(evt,data){var download=true;if(data.style_id&&$("#"+data.style_id).length>0){download=false;}if(download){TDI.Tools.getStyle(data.style_src,{id:data.style_id,complete:function(node){data.style_node=node;$(document).trigger("tdi:ajax:style",data);}});}}function _onReloadDefault(evt,data){window.location.reload(true);}function _onRedirectDefault(evt,data){window.location.assign(data.href);}function _onPopupDefault(evt,data){var params="",popup;if(data.mode==="dialog"){params+="width="+data.width+", height="+data.height;}data.popup=window.open(data.href,"_blank",params);$(document).trigger("tdi:ajax:popup",data);}function _onUnknownDefault(evt,data){$(document).trigger("tdi:ajax:"+data._name,data);}var i,customHandlers={"tdi:ajax:beforeUpdate":_onUpdateDefault,"tdi:ajax:beforeInsert":_onInsertDefault,"tdi:ajax:beforeScript":_onScriptDefault,"tdi:ajax:beforeStyle":_onStyleDefault,"tdi:ajax:beforeReload":_onReloadDefault,"tdi:ajax:beforeRedirect":_onRedirectDefault,"tdi:ajax:beforePopup":_onPopupDefault},customDefault=function(evt,data){if(customHandlers[evt.type]){customHandlers[evt.type].call(this,evt,($.isArray(data)?data[1]:data));}else{_onUnknownDefault.call(this,evt,($.isArray(data)?data[1]:data));}};for(i in customHandlers){$.event.special[i]={_default:customDefault};}return{};}(jQuery);TDI.Tools=function($){return{getScript:function(url,options){var loaded=false,node;if(url){options=options||{};node=document.createElement("script");node.type="text/javascript";node.src=url;if(options.id){node.id=options.id;}if(options.complete){node.onreadystatechange=function(){var rs=this.readyState;if(!loaded&&(rs==="loaded"||rs==="complete")){loaded=true;node.onreadystatechange=null;options.complete(node);}};node.onload=function(){if(!loaded){loaded=true;options.complete(node);}};}document.getElementsByTagName("head")[0].appendChild(node);}},getStyle:function(url,options){var node;if(url){options=options||{};node=document.createElement("link");node.rel="stylesheet";node.type="text/css";node.media=options.media||"screen";node.href=url;if(options.id){node.id=options.id;}document.getElementsByTagName("head")[0].appendChild(node);options.complete&&options.complete(node);}}};}(jQuery);
